
## 四次挥手

建立一个连接需要三次握手，而终止一个连接要经过 4 次挥手。 这由 TCP 的 半关闭(half-close) 造成的。  

既然一个 TCP 连接 是全双工 (即数据 在两个方向上 能同时传递)， 因此每个方向 必须单独地进行关闭。   
这原则就是  当一方 完成 它的数据发送 任务后  就能发送一个 FIN 来终止 这个方向连接。  
当一端 收到一个 FIN，它必须 通知应用层 另一端 已经终止了 数据传送。  

理论上 客户端和服务器 都可以发起主动关闭，但是更多的情况下  是 客户端主动发起。  




客户端：  FIN=1         seq=x  
服务器：  ACK=1         ack=x+1   seq=y   

服务器：  ACK=1  FIN=1  ack=x+1   seq=z   
客户端：         ACK=1  seq=x+1   ack=z+1   







## TCP 关闭 连接 为什么 要四次而不是三次？

服务器 在收到客户端的 FIN 报文段后，可能还有一些数据要传输，所以不能马上关闭连接，
但是 会做出应答，返回 ACK 报文段，  接下来 可能会 继续发送数据，

在数据发送完后，服务器 会向客户端 发送 FIN 报文， 表示 数据已经发送完毕，请求关闭连接，
然后 客户端 再做出应答，因此一共 需要四次挥手。






## 客户端为什么需要在 TIME-WAIT 状态 等待 2MSL 时间 才能进入 CLOSED 状态？

按照常理，在网络正常的情况下，四个报文段发送完后，双方就可以关闭连接 进入 CLOSED 状态了，
但是网络并不总是可靠的，如果 客户端发送的 ACK 报文段丢失，服务器 在接收不到 ACK 的情况下会一直重发 FIN 报文段，这显然不是我们想要的。  

因此客户端 为了确保服务器收到了 ACK，会设置一个定时器，并在 TIME-WAIT 状态等待 2MSL 的时间，
如果在此期间 又收到了来自服务器的 FIN 报文段，那么客户端会重新设置计时器 并再次等待 2MSL 的时间， 
如果在这段时间内 没有收到 来自服务器的 FIN 报文，那就说明服务器已经成功收到了 ACK 报文，
此时客户端就可以进入 CLOSED 状态了。  